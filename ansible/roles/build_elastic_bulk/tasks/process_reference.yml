---
- name: Set reference variables for {{ reference.filename }}
  set_fact:
    ref_id: "{{ reference.id }}"
    ref_filename: "{{ reference.filename }}"
    ref_data_stream: "{{ reference.data_stream }}"
    ref_pipeline: "{{ pipeline_mapping[reference.data_stream] | default(omit) }}"

- name: Determine data source directory for {{ ref_filename }}
  set_fact:
    data_source_dir: "{{ playbook_dir }}/../../data/sequence/security/{{ ref_data_stream | regex_replace('logs-(.+?)\\..+', '\\1') }}"

- name: Find specific .ndjson file {{ ref_filename }}
  find:
    paths: "{{ data_source_dir }}"
    patterns: "{{ ref_filename }}"
  register: ndjson_files

- name: Convert {{ ref_filename }} to Elasticsearch bulk format
  command: |
    python3 "{{ role_path }}/files/convert_ndjson_to_bulk.py"
            "{{ ndjson_file.path }}"
            "{{ build_dir | default(dest_base + '/bulk') }}/{{ ndjson_file.path | basename | splitext | first }}.bulk.ndjson"
            "{{ time_offset_minutes | default(0) }}"
  loop: "{{ ndjson_files.files }}"
  loop_control:
    loop_var: ndjson_file
  args:
    chdir: "{{ build_dir | default(dest_base + '/bulk') }}"
  when: ndjson_files.files | length > 0

- name: Create metadata directory (parallel to bulk directory)
  file:
    path: "{{ build_dir | default(dest_base + '/bulk') | dirname }}/bulk_metadata"
    state: directory
    mode: '0755'

- name: Create pipeline metadata file for {{ ref_filename }}
  copy:
    content: |
      data_stream: {{ ref_data_stream }}
      pipeline: {{ ref_pipeline.ingest_pipeline | default('') }}
    dest: "{{ build_dir | default(dest_base + '/bulk') | dirname }}/bulk_metadata/{{ ndjson_file.path | basename | splitext | first }}.bulk.meta"
    mode: '0644'
  loop: "{{ ndjson_files.files }}"
  loop_control:
    loop_var: ndjson_file
  when: ndjson_files.files | length > 0

- name: Verify {{ ref_filename }} bulk file was created
  stat:
    path: "{{ build_dir | default(dest_base + '/bulk') }}/{{ item.path | basename | splitext | first }}.bulk.ndjson"
  loop: "{{ ndjson_files.files }}"
  register: bulk_files_check
  when: ndjson_files.files | length > 0
