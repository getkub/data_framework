---
- name: Find all CSV reference files
  find:
    paths: "{{ playbook_dir }}/../../data/sequence/security"
    patterns: "01*.csv"
  register: csv_files

- name: Read all CSV files
  read_csv:
    path: "{{ item.path }}"
    key: id
  register: csv_file_data
  loop: "{{ csv_files.files }}"

- name: Combine CSV data from all files
  set_fact:
    csv_data:
      dict: "{{ csv_file_data.results | map(attribute='dict') | combine }}"
      list: "{{ csv_file_data.results | map(attribute='list') | flatten }}"

- name: Filter references by IDs across all CSV files (if reference_ids provided)
  set_fact:
    selected_references: "{{ csv_data.dict | dict2items | selectattr('key', 'in', reference_ids) | map(attribute='value') | list }}"
  when: reference_ids is defined

- name: Use all references if no filtering requested
  set_fact:
    selected_references: "{{ csv_data.dict | dict2items | map(attribute='value') | list }}"
  when: reference_ids is not defined

- name: Display selected references count
  debug:
    msg: "Loaded {{ selected_references | default([]) | length }} references"
  when: selected_references is defined
