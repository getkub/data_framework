---
- name: Extract filename from bulk file path
  set_fact:
    bulk_filename: "{{ bulk_file.path | basename | regex_replace('\\.bulk\\.ndjson$', '') }}"

- name: Find matching reference for {{ bulk_filename }}
  set_fact:
    matching_reference: "{{ csv_data.dict | dict2items | selectattr('value.filename', 'equalto', bulk_filename + '.ndjson') | map(attribute='value') | first | default({}) }}"

- name: Set deployment variables for {{ bulk_filename }}
  set_fact:
    ref_data_stream: "{{ matching_reference.data_stream | default('logs-windows.security-default') }}"
    ref_pipeline: "{{ matching_reference.pipeline | default('logs-system.security-2.6.3-standard') }}"

- name: Deploy {{ bulk_filename }}.bulk.ndjson to Elasticsearch
  uri:
    url: "{{ elastic_protocol }}://{{ elastic_host }}:{{ elastic_port }}/{{ ref_data_stream }}/_bulk?pipeline={{ ref_pipeline }}"
    method: POST
    headers:
      Authorization: "ApiKey {{ elastic_api_key }}"
      Content-Type: "application/x-ndjson"
    body: "{{ lookup('file', bulk_file.path) }}"
    validate_certs: "{{ not skip_ssl_verify }}"
    timeout: "{{ deployment_timeout }}"
    status_code: [200, 201]
  register: bulk_responses

- name: Check for bulk ingestion errors for {{ bulk_filename }}
  fail:
    msg: "Bulk ingestion failed for {{ bulk_file.path }}: {{ bulk_responses.content | to_json }}"
  when:
    - bulk_responses.status is defined
    - bulk_responses.status not in [200, 201]

- name: Display results for {{ bulk_filename }}
  debug:
    msg: "File: {{ bulk_file.path | basename }} - Status: {{ bulk_responses.status | default('skipped') }} - Data Stream: {{ ref_data_stream }} - Pipeline: {{ ref_pipeline }}"
  when: bulk_responses.status is defined and bulk_responses.status in [200, 201]
