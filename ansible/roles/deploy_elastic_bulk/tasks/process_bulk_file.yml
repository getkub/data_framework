---
- name: Extract filename from bulk file path
  set_fact:
    bulk_filename: "{{ bulk_file.path | basename | regex_replace('\\.bulk\\.ndjson$', '') }}"

- name: Read metadata file for {{ bulk_filename }}
  slurp:
    src: "{{ bulk_source_dir | dirname }}/bulk_metadata/{{ bulk_filename }}.bulk.meta"
  register: metadata_file
  ignore_errors: true

- name: Parse metadata for {{ bulk_filename }}
  set_fact:
    file_data_stream: "{{ (metadata_file.content | b64decode | from_yaml).data_stream | default(elastic_data_stream | default('logs-windows.security-default')) }}"
    file_pipeline: "{{ (metadata_file.content | b64decode | from_yaml).pipeline | default(elastic_pipeline | default('')) }}"
  when: metadata_file.content is defined

- name: Set defaults if metadata not found
  set_fact:
    file_data_stream: "{{ elastic_data_stream | default('logs-windows.security-default') }}"
    file_pipeline: "{{ elastic_pipeline | default('') }}"
  when: metadata_file.content is not defined

- name: Deploy {{ bulk_filename }}.bulk.ndjson to Elasticsearch
  uri:
    url: "{{ elastic_protocol }}://{{ elastic_host }}:{{ elastic_port }}/{{ file_data_stream }}/_bulk{% if file_pipeline %}?pipeline={{ file_pipeline }}{% endif %}"
    method: POST
    headers:
      Authorization: "ApiKey {{ elastic_api_key }}"
      Content-Type: "application/x-ndjson"
    body: "{{ lookup('file', bulk_file.path) }}"
    validate_certs: "{{ not skip_ssl_verify }}"
    timeout: "{{ deployment_timeout }}"
    status_code: [200, 201]
  register: bulk_responses
  ignore_errors: true

- name: Check for connection errors
  fail:
    msg: "Cannot connect to Elasticsearch at {{ elastic_protocol }}://{{ elastic_host }}:{{ elastic_port }}. Please ensure Elasticsearch is running and accessible."
  when:
    - bulk_responses.status is defined
    - bulk_responses.status == -1

- name: Check for bulk ingestion errors for {{ bulk_filename }}
  fail:
    msg: "Bulk ingestion failed for {{ bulk_file.path }}: {{ bulk_responses.content | to_json }}"
  when:
    - bulk_responses.status is defined
    - bulk_responses.status not in [200, 201]
    - bulk_responses.status != -1

- name: Display results for {{ bulk_filename }}
  debug:
    msg: "File: {{ bulk_file.path | basename }} - Status: {{ bulk_responses.status | default('skipped') }}"
  when: bulk_responses.status is defined and bulk_responses.status in [200, 201]
